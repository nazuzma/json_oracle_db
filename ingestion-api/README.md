# RESTFul Ingestion API User Documentation

The present document describes how to use the ingestion API to upload FEA data to the EM repository.

## Architecture Overview

The HTTP RESTful data ingestion API was developed in [Python](https://www.python.org/) with [Flask](https://pypi.org/project/Flask/). It's also using several Flask extension libraries such as [Flask-Auth](https://pypi.org/project/Flask-Auth/) and [Flask-API](https://pypi.org/project/Flask-API/). The API uses an Oracle 12c relational database (Oracle 12c) as a primary storage system.

## Deployment

Deployment in done automatically by [build & deployment plan](https://bamboo.goodyear.eu/browse/DS-ERIAE) hosted by the Goodyear [Bamboo](https://bamboo.goodyear.eu/) server owned by EMEA IT. Deployment are triggers by any push to the master branch of the [code repository](https://github.com/goodyear/em-repository).

The production host is ```gisvms70.gis.goodyear.com```, a general-purpose back-end server owned by the DS&A team. It's a SLES-12 VM administrated by Regional IT and hosted in the Goodyear EMEA server farm.

## Location

The HTTP RESTful data ingestion API is available at the following address:  
**[http://gisvms70.gis.goodyear.com:5000/](http://gisvms70.gis.goodyear.com:5000/)**

Please preferably use the fully qualified name of the server (i.e. with the "```.gis.goodyear.com```" suffix) in your application in order to prevent any connectivity issue if your application runs from another location than GIC\*L, where the "gis" suffix might not have been listed in user's network settings.

## Security

The API is protected by a [Basic HTTP Authentication](https://en.wikipedia.org/wiki/Basic_access_authentication) protocol, which basically consists in a user name and a password that must be passed along any call to the API, as part of the underlying HTTP request. 

Typically, a machine account, such as ```lda5148```, is used to invoke the API programmatically. Please contact the project owners to get a valid password or to create a new user. There is no integrations with GAIMS/LDAP at this point; but it's a possible option, should the system be used more widely.

## Client Connection

In Python, connecting to the API may be done very easily with any library supporting the RESTful protocol such as [requests](https://requests.readthedocs.io/en/latest/), which also supports basic authentication protocols through the [requests.auth](https://requests.readthedocs.io/en/latest/user/authentication/#basic-authentication) namespace.

### Simple function roundtrip example in Python

```Python
import requests
from requests.auth import HTTPBasicAuth

url = 'http://gisvms70.gis.goodyear.com:5000/api/ping'
auth = HTTPBasicAuth('lda5148', '***')
response = requests.get(url, auth=auth)
assert response.status_code == 200
assert response.json()['message'] == 'Hello!'
```

:warning: Passwords shall not appear in clear in your source code! It's highly recommended to store passwords either in a separate file (not included of the code repository), or in any encrypted form (e.g. Fernet symmetric encryption)

## API Reference

### Ping (GET)

A GET method which returns unconditionally a 200 status code (success) with a simple JSON response `{"message":"Hello!"}`. Itâ€™s just a convenient hand shaking fake function to test connectivity.

See the example above in the previous section.

### Upload (POST)

A POST method which expects a JSON text file generated by BriskGen3 to be provided (preferably open in binary mode) as a Multipart-Encoded File. It returns a 201 status code (resource created) if the upload process was successful, otherwise an error message will explain the problem.

When successful, the function also provides in the JSON part of the response the following data:
* `id`: the ID of the main geometry record in the database. That handler can be passed further to the "attach" function, in order to attach extra data files to the main record.
* `vti_map`: *coming soon!*


```Python
import requests
from requests.auth import HTTPBasicAuth

base_url = 'http://gisvms70.gis.goodyear.com:5000/api'

files = {'file': open('/the/path/sample.json', 'rb')}
auth = HTTPBasicAuth('lda5148', '***')
response = requests.post(base_url + '/upload', auth=auth, files=files)

if response.status_code != 201:
  print('An error has occurred: {0} (code {1})'.format(response.json()['message'], response.status_code))
```

### Attach (POST)

A POST method which expects a data file to be attached to a previously uploaded geometry and identified by an ID returned by the "upload" function. It returns a 201 status code (resource created) if the attachmnent was successful, otherwise an error message will explain the problem.

The ID must be provided in URL argument with the following syntax: `".../attach/{ID}"` (see example below)

```Python
import requests
from requests.auth import HTTPBasicAuth

base_url = 'http://gisvms70.gis.goodyear.com:5000/api'

files = {'file': open('/the/path/sample.json', 'rb')}
auth = HTTPBasicAuth('lda5148', '***')
response = requests.post(base_url + '/upload', auth=auth, files=files)

if response.status_code != 201:
  # Error handling here...

id = response.json()['id']
files = {'file': open('/the/path/attachment.csv', 'rb')}
response = requests.post(base_url + '/attach/{0}'.format(id), auth=auth, files=files)

if response.status_code != 201:
  # Error handling here...
```

You can attach as many data files as you want by calling the `attach` function multiple times.


## Human-friendly upload GUI

A simple human-friendly form is available at http://gisvms70.gis.goodyear.com:5000/ for manual file submission.



